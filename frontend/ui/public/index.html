<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>React App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <script>
      function startStreaming() {
        const userInput = document.getElementById('user-input').value;
        const output = document.getElementById('streaming-output');
        output.innerHTML = '';
        
        // Mock data for testing - matches the format from db.ts
        const requestData = {
          prompt: userInput,
          memory: [
            {
              datetime: '2024-07-28T10:30:00',
              text: "Patient reports difficulty falling asleep and staying asleep"
            },
            {
              datetime: '2024-07-28T11:15:00',
              text: "Patient mentioned work stress affecting sleep quality"
            },
            {
              datetime: '2024-07-28T14:20:00',
              text: "Patient prefers room temperature at 68¬∞F for optimal sleep"
            },
            {
              datetime: '2024-07-28T16:45:00',
              text: "Patient has been exercising regularly but sometimes too close to bedtime"
            },
            {
              datetime: '2024-07-29T09:30:00',
              text: "Patient is allergic to penicillin, shellfish, and dairy products"
            },
            {
              datetime: '2024-07-29T12:00:00',
              text: "Patient takes melatonin 5mg and zolpidem 10mg for sleep"
            },
            {
              datetime: '2024-07-29T15:30:00',
              text: "Patient enjoys cardio exercises and strength training"
            },
            {
              datetime: '2024-07-29T18:00:00',
              text: "Patient has upcoming sleep specialist appointment on August 20th"
            }
          ],
          patientProfile: {
            uid: "user-001",
            name: "John Doe",
            age: 35,
            bloodType: "O+",
            allergies: ["Penicillin", "Shellfish", "Dairy"],
            medicationList: ["Melatonin 5mg", "Zolpidem 10mg", "Multivitamin", "Omega-3 supplements"],
            dailyChecklist: ["Take melatonin at 9 PM", "Avoid screens 1 hour before bed", "Keep room temperature at 68¬∞F", "30 minutes cardio", "Strength training 3x/week", "Stretching routine"],
            appointment: "2024-08-20T14:00:00",
            recommendations: ["Practice sleep hygiene", "Limit caffeine after 2 PM", "Exercise regularly but not close to bedtime", "Gradual increase in exercise intensity", "Stay hydrated during workouts", "Listen to body signals"],
            sleepHours: 7,
            sleepQuality: "Fair"
          },
          updates: [
            {
              datetime: '2024-07-28T10:30:00',
              text: 'Patient reported sleep difficulties and work stress'
            },
            {
              datetime: '2024-07-28T11:15:00',
              text: 'Added stress management recommendations to sleep treatment plan'
            },
            {
              datetime: '2024-07-28T14:20:00',
              text: 'Updated room temperature preference in sleep checklist'
            },
            {
              datetime: '2024-07-28T16:45:00',
              text: 'Modified exercise timing recommendations to avoid late workouts'
            },
            {
              datetime: '2024-07-29T09:30:00',
              text: 'Confirmed allergy list: penicillin, shellfish, dairy'
            },
            {
              datetime: '2024-07-29T12:00:00',
              text: 'Reviewed current medication list: melatonin 5mg, zolpidem 10mg'
            }
          ]
        };
        
        // Send POST request to start streaming
        fetch('/api/agent/stream', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestData)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // Create EventSource for streaming
          const eventSource = new EventSource('/api/agent/stream');
          
          eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('Received chunk:', data);
            
            // Add to output
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `[${timestamp}] ${data.type}: ${JSON.stringify(data.data, null, 2)}\n`;
            output.scrollTop = output.scrollHeight;
            
            // Handle different chunk types
            switch(data.type) {
              case 'streaming_started':
                output.innerHTML += `[${timestamp}] üöÄ Started streaming session\n`;
                break;
                
              case 'unmute_connecting':
                output.innerHTML += `[${timestamp}] üîó Connecting to voice assistant...\n`;
                break;
                
              case 'unmute_connected':
                output.innerHTML += `[${timestamp}] ‚úÖ Connected to voice assistant\n`;
                break;
                
              case 'unmute_streaming_started':
                output.innerHTML += `[${timestamp}] üé§ Voice assistant responding...\n`;
                break;
                
              case 'text_chunk':
                output.innerHTML += `[${timestamp}] üìù Text: "${data.data.text}"\n`;
                break;
                
              case 'audio_chunk':
                output.innerHTML += `[${timestamp}] üîä Audio chunk: ${data.data.audio.length} bytes\n`;
                break;
                
              case 'text_complete':
                output.innerHTML += `[${timestamp}] ‚úÖ Text complete\n`;
                break;
                
              case 'audio_complete':
                output.innerHTML += `[${timestamp}] ‚úÖ Audio complete\n`;
                break;
                
              case 'unmute_complete':
                output.innerHTML += `[${timestamp}] ‚úÖ Voice assistant complete\n`;
                break;
                
              case 'workflow_complete':
                output.innerHTML += `[${timestamp}] üéâ Workflow complete!\n`;
                eventSource.close();
                break;
                
              case 'error':
              case 'workflow_error':
              case 'unmute_error':
              case 'unmute_timeout':
                output.innerHTML += `[${timestamp}] ‚ùå Error: ${data.data.message}\n`;
                eventSource.close();
                break;
                
              case 'keepalive':
                // Keep connection alive
                break;
            }
          };
          
          eventSource.onerror = function(error) {
            console.error('EventSource failed:', error);
            output.innerHTML += `[${new Date().toLocaleTimeString()}] ‚ùå Connection error\n`;
            eventSource.close();
          };
          
          console.log('Starting streaming with data:', requestData);
        })
        .catch(error => {
          console.error('Error starting streaming:', error);
          output.innerHTML += `[${new Date().toLocaleTimeString()}] ‚ùå Failed to start streaming: ${error.message}\n`;
        });
      }
    </script>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
  </body>
</html>
